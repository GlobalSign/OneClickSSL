#!/usr/local/bin/php
<?php
$config = $_ENV['DOCUMENT_ROOT'] .'/../etc/oneclick.conf';
$settings = unserialize(file_get_contents($config));

define("DASERVER", "http://". $_SERVER['SERVER_ADDR'] .":". $_SERVER['SERVER_PORT']);
define("DAUSERNAME", $settings['da_user'] ."|". $_ENV['USERNAME']);
define("DAPASSWORD", $settings['da_passwd']);

parse_str($_ENV['QUERY_STRING'], $rqstr);

		// Update the private key and the certificate for this website
		$qstr = array();
		$qstr['domain'] = $rqstr['domain'];
		//$qstr['action'] = 'view';
		
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, DASERVER .'/CMD_API_SSL?domain='. $qstr['domain']);
		curl_setopt($ch, CURLOPT_USERPWD, DAUSERNAME .':'. DAPASSWORD);
		//curl_setopt($ch, CURLOPT_POST, true);
		//curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($qstr));
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); 
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_TIMEOUT, 30);
		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_HEADER, false);
		$result = curl_exec($ch);
		$resultStatus = curl_getinfo($ch);
		
		// Did Curl returned an error?
		if(curl_errno($ch)) {
			echo "Error in communication with DirectAdmin (".  curl_error($ch) ."), is the plugin correctly configured?";
			return false;
		}
		curl_close($ch);
		
		parse_str($result, $reponse);
		
		echo "<pre>";
		print_r($reponse);
		echo "</pre>";
	exit;	
		
		// ***********************************************************************
		
		
		// Update the private key and the certificate for this website
		//$cmd = '/CMD_PLUGINS/OneClickSSL/order.raw?d=directadmin.paul.vanbrouwershaven.com&o=paul.vanbrouwershaven@globalsign.com&v=5daytrialDV'
		$cmd = '/CMD_API_LOGIN_KEYS';
	
		$ch = curl_init();
		curl_setopt($ch, CURLOPT_URL, DASERVER . $cmd);
		curl_setopt($ch, CURLOPT_USERPWD, 'admin:test1234');
		curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); 
		curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
		curl_setopt($ch, CURLOPT_TIMEOUT, 30);
		curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, false);
		curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($ch, CURLOPT_HEADER, false);
		$result = curl_exec($ch);
		$resultStatus = curl_getinfo($ch);
		
		// Did Curl returned an error?
		if(curl_errno($ch)) {
			echo "Error in communication with DirectAdmin (".  curl_error($ch) ."), is the plugin correctly configured?";
			return false;
		}
		curl_close($ch);
		
		parse_str($result, $reponse);
		parse_str($reponse['OneClickSSL'], $OneClickSSL);
		
		
		echo "<pre>+++++++";
		print_r($reponse);
		print_r($OneClickSSL);
		echo "</pre>";
		

?>